<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>my-day</title>
    <style>
        .fl{float: left;}
        .fr{float: right;}
        body{
            width: 1260px;
            margin: auto;
            margin-top: 0px;
        }
        .container{
            width: 100%;
            margin: 0px auto 40px auto;
            position: relative;
        }
        
        /*顶部信息条*/
        .info{
            position: fixed;
            background-color: #cff;
            top: 0px;
            left: 0;
            right: 0;
            padding: 5px 25px 0px;
            height: 75px;
            text-align: center;
            box-shadow: 0 0 2px #888;
        }

        .info::after,
        .container::after{
            content: '';
            display: block;
            height: 0px;
            clear: both;
        }
        .title,
        .daysInfo,
        .setting{
            display: inline-block;
            vertical-align: top;
            height: 66px;
        }
        .title{
            margin-right: 40px;
            font-family: Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif;
            color: #800080;
        }
        .daysInfo{
            text-align: center;
        }
        .daysInfo td{
            padding: 5px 15px;
            font-size: 130%;
            font-weight: bold;
        }
        .total-num{
            font-size: 100%;
        }
        .left-num{
            color: #f40;
        }
        .gone-num{
            color: #666;
        }
        .average-score{
            color: #088;
        }
        .current-score{
            min-width: 45px;
        }
        
        /* 字体设置按钮 */
        .setting{
            height: 40px;
            padding: 16px 0 0 60px;
        }
        .setting button{
            width: 48px;
            height: 36px;
            color: #06c;
            font-size: 100%;
            background-color: #fff;
            border: 1px solid #ccc;
            cursor: pointer;
            outline: none;
        }
        button.selected{
            background-color: #ccc;
        }
        button:hover{
            border-color: #aaa;
        }

        /* 方格样式 */
        .days{
            padding-top: 84px;
        }
        .days .day{
            float: left;
            border: 1px solid #aaa;
            cursor: pointer;
            width: 3px;
            height: 3px;
        }
        .middle .day{
            width: 6px;
            height: 6px;
        }
        .large .day{
            width: 12px;
            height: 12px;
        }
        .day:hover{
            border-color: #000;
        }
        
    </style>
</head>
<body>

    <div class="container middle">

        <div class="info">
            <h2 class="title">My 75 Years</h2>
            <table class="daysInfo">
                <tr>
                    <th>总计天数</th>
                    <th>已活天数</th>
                    <th>剩余天数</th>
                    <th>平均得分</th>
                    <th>当前日期</th>
                    <th>当前分数</th>
                </tr>
                <tr id="daysInfo">
                    <td class="total-num"></td>
                    <td class="gone-num"></td>
                    <td class="left-num"></td>
                    <td class="average-score"></td>
                    <td class="current-date"></td>
                    <td class="current-score"></td>
                </tr>
            </table>
            <div class="setting">
                <button data-size="small" class="small">小</button>
                <button data-size="middle" class="middle selected">中</button>
                <button data-size="large" class="large">大</button>
            </div>
        </div>
        <div class="days">
            <!-- <span class="day" data-score="80" data-day="2018-10-23"></span> -->
        </div>
    </div>

    <script>
        // 信息显示
        let daysInfo = {
            node: document.querySelector('.daysInfo'),
            currentDate: document.querySelector('.daysInfo .current-date'),
            currentScore: document.querySelector('.daysInfo .current-score'),
            refresh(date, score){
                this.currentDate.innerHTML = date;
                this.currentScore.innerHTML = score;
            }
        };

        // 大小控制
        let setting = {
            node: document.querySelector('.setting'),
            buttons: [].slice.apply(document.querySelectorAll('.setting button')),
            init(){
                setting.node.onclick = function(e){
                    let target = e.target;
                    if(target.tagName.toLowerCase() === 'button'){
                        setting.buttons.forEach(item=>{
                            item.classList.remove('selected');
                            app.container.classList.remove(item.getAttribute('data-size'));
                        });
                        target.classList.add('selected');
                        app.container.classList.add(target.getAttribute('data-size'));
                    }
                };
            }
        };


        // 该对象用于表示了某天的日期及其在文档中对应的节点
        function Day(year, month, day) {
            this.node = null;
            this.year = year;
            this.month = month; // start form 0
            this.day = day;
            this.dateStr = year + '-' +('0'+(month + 1)).slice(-2) + '-' + ('0'+day).slice(-2);
            this.isPassed = new Date(this.year, this.month, this.day).getTime() + Day.MS_OF_ONE_DAY < Date.now();
            this.init(); //创建出该日期的文档节点（未插入文档）
        }
        Day.MS_OF_ONE_DAY = 24 * 60 * 60 * 1000;
        Day.prototype = {
            constructor: Day,
            now: new Date(),
            today: (function () {
                let d = new Date();
                return new Date(d.getFullYear(), d.getMonth(), d.getDate());
            })(),
            init() {
                // 创建出该日期的文档节点（未插入文档）
                let span = document.createElement('span');
                span.setAttribute('data-day', this.dateStr);
                let score = scoreData.getScoreByDate(this.year, this.month, this.day);
                if (!score) score = this.isPassed ? scoreData.defaultScore : 0;
                span.setAttribute('data-score', score);
                span.setAttribute('data-date', this.dateStr);
                span.className = 'day';
                if (this.isPassed) {
                    span.className += ' passed';
                    let color = Color.getColorByScore(score);
                    span.style.backgroundColor = color;
                }
                this.node = span;
            },

        };
        
        let birthday = {
            year: 1993,
            month: 4, // start from 0
            day: 24,
            date: new Date(1993, 4, 24)
        };
        let scoreData = {
            data: [],
            defaultScore: 85,
            todayIndex: (function(){
                let now = new Date();
                let year = now.getFullYear(),
                    month = now.getMonth(),
                    day = now.getDate();
                return (new Date(year, month, day).getTime() - birthday.date.getTime()) / Day.MS_OF_ONE_DAY;
            })(),
            getIndexOfDay(year, month, day){
                return (new Date(year, month, day).getTime() - birthday.date.getTime()) / Day.MS_OF_ONE_DAY;
            },
            getScoreByDate(year, month, day){
                // 获取某日期的得分
                return this.data[this.getIndexOfDay(year, month, day)];
            },
            setScoreByDate(year, month, day, score){
                // 存储某日期的得分
                return this.data[this.getIndexOfDay(year, month, day)] = score;
            },
            initScoreData(callback){
                //请求./data/score.json，遍历存储
                let self = this;

                // 设置以往没有分数记录的日期的默认分数
                let defaultScore = this.defaultScore,
                    todayIndex = this.todayIndex,
                    data = this.data;
                for(let i = 0; i < todayIndex; i++){
                    data[i] = defaultScore;
                }

                // 获取到数据后的遍历存储函数
                let loadData = function(data){
                    data = JSON.parse(data);
                    data.forEach((item) => {
                        let startTime = item.startTime.split('-');
                        let date = new Date(startTime[0], startTime[1]-1, startTime[2]);
                        let scores = item.score;
                        scores.forEach((score) => {
                            self.setScoreByDate(date.getFullYear(), date.getMonth(), date.getDate(), score);
                            date = new Date(date.getTime() + Day.MS_OF_ONE_DAY);
                        });
                    });
                };

                // ajax请求获取score.json
                let xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function(){
                    if(xhr.readyState === 4){
                        if((xhr.status >= 200 && xhr.status < 300) || xhr.status === 304){
                            loadData(xhr.responseText);
                        }else{
                            console.log('fail to load score.json');
                        }
                        callback && callback();
                    }
                };
                xhr.open('get', './data/score.json', true);
                xhr.send(null);
            },
            getAverage(){
                let scoreSum = 0,
                    data = this.data,
                    todayIndex = this.todayIndex;
                for(let i = 0; i < todayIndex; i++){
                    scoreSum += data[i];
                }
                return scoreSum/todayIndex;
            }
        };
        let Color = {
            getColorByScore(score) {
                // 获取某得分对应的背景色，通过对rgb值查表线性插入
                let table = {
                    score: [-20, 0, 100],
                    red: [255, 255, 0],
                    green: [0, 255, 136],
                    blue: [0, 0, 0]
                };
                let len = table.score.length,
                    min = table.score[0], //最低分
                    max = table.score[table.score.length - 1]; //最低分
                score = score < min ? min : (score > max ? max : score);
                let minIndex = 0, maxIndex = 1;
                for (let i = 0; i < len; i++) {
                    if (score > table.score[i]) {
                        minIndex = i;
                    } else {
                        break;
                    }
                }
                maxIndex = Math.min(minIndex + 1, len - 1);
                let red = table.red[minIndex] + (table.red[maxIndex] - table.red[minIndex]) / (table.score[maxIndex] - table.score[minIndex]) * (score - table.score[minIndex]);
                let green = table.green[minIndex] + (table.green[maxIndex] - table.green[minIndex]) / (table.score[maxIndex] - table.score[minIndex]) * (score - table.score[minIndex]);
                let blue = table.blue[minIndex] + (table.blue[maxIndex] - table.blue[minIndex]) / (table.score[maxIndex] - table.score[minIndex]) * (score - table.score[minIndex]);
                return 'rgb(' + red.toFixed(0) + ',' + green.toFixed(0) + ',' + blue.toFixed(0) + ')';
            }
        };
        
        let app = {
            container: document.getElementsByClassName('container')[0],
            days: document.getElementsByClassName('days')[0],
            YEAR_TO_LIVE: 75,
            DAYS_TO_LIVE: (new Date(birthday.year+75, birthday.month, birthday.day).getTime() - birthday.date.getTime())/Day.MS_OF_ONE_DAY + 1,
            start(){
                // 启动页面
                // 请求score.json，并渲染
                setting.init();
                scoreData.initScoreData(this.initRender.bind(this));
                this.setHandler();
            },
            initRender(){
                // 在已经得到个日期得分数据的情况下，渲染整个页面
                this.showDaysInfo();
                let frag = document.createDocumentFragment();
                let currentDate = birthday.date;
                for(let i = 0; i < this.DAYS_TO_LIVE; i++){
                    let span = new Day(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate()).node;
                    frag.appendChild(span);
                    currentDate = new Date(currentDate.getTime() + Day.MS_OF_ONE_DAY);
                }
                this.days.appendChild(frag);
            },
            showDaysInfo(){
                let daysInfo = document.getElementById('daysInfo');
                let tds = daysInfo.getElementsByTagName('td');
                let goneDays = ((Date.now() - birthday.date.getTime()) / Day.MS_OF_ONE_DAY).toFixed(0);
                tds[0].innerHTML = this.DAYS_TO_LIVE;
                tds[1].innerHTML = goneDays;
                tds[2].innerHTML = this.DAYS_TO_LIVE - goneDays;
                tds[3].innerHTML = scoreData.getAverage().toFixed(2);
                tds[4].innerHTML = '0000-00-00';
                tds[5].innerHTML = '00';
            },
            setHandler(){
                // 鼠标移入方格时，显示当前方格的日期和分数
                this.days.onmouseover = function(e){
                    let target = e.target;
                    if(target.tagName.toLowerCase() === 'span'){
                        daysInfo.refresh(target.getAttribute('data-date'), target.getAttribute('data-score'));
                    }
                };
            }
        };
        app.start();
        
    </script>

</body>
</html>